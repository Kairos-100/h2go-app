<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H2GO Document Upload - Train AI</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .upload-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .upload-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .upload-header h1 {
            font-size: 2.5rem;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        
        .upload-header p {
            font-size: 1.1rem;
            color: #64748b;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        @media (max-width: 768px) {
            .upload-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .upload-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .upload-card h3 {
            color: #2563eb;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }
        
        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .drop-zone-icon {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }
        
        .drop-zone-text {
            color: #475569;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .drop-zone-hint {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-upload {
            background: #2563eb;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-upload:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .file-list {
            margin-top: 2rem;
        }
        
        .file-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }
        
        .file-icon {
            font-size: 1.5rem;
            color: #2563eb;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .file-size {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            background: transparent;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .btn-icon:hover {
            color: #ef4444;
            background: #fee2e2;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: #2563eb;
            transition: width 0.3s ease;
        }
        
        .upload-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
        }
        
        .stat-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .stat-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .stat-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .training-options {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .training-options h4 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .option-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        .option-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .option-card h5 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .option-card p {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-success {
            background: #dcfce7;
            border: 1px solid #86efac;
            color: #166534;
        }
        
        .alert-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .alert-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            color: #1e40af;
        }
        
        .alert-icon {
            font-size: 1.2rem;
        }
        
        .processing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .processing-modal.active {
            display: flex;
        }
        
        .processing-content {
            background: white;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .document-types {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .type-badge {
            background: #eff6ff;
            color: #2563eb;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Processing Modal -->
    <div id="processingModal" class="processing-modal">
        <div class="processing-content">
            <div class="spinner"></div>
            <h3>Procesando Documentos...</h3>
            <p id="processingStatus">Analizando contenido y entrenando la IA</p>
        </div>
    </div>

    <div class="upload-container">
        <!-- Header -->
        <div class="upload-header">
            <h1><i class="fas fa-file-upload"></i> Entrenar IA con Documentos</h1>
            <p>Sube documentos para mejorar el conocimiento y las recomendaciones de la IA</p>
        </div>

        <!-- Stats -->
        <div class="upload-stats">
            <div class="stat-card blue">
                <div class="stat-value" id="totalDocuments">0</div>
                <div class="stat-label">Documentos Procesados</div>
            </div>
            <div class="stat-card green">
                <div class="stat-value" id="totalPages">0</div>
                <div class="stat-label">Páginas Analizadas</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-value" id="trainingDataPoints">0</div>
                <div class="stat-label">Puntos de Datos</div>
            </div>
        </div>

        <!-- Main Upload Grid -->
        <div class="upload-grid">
            <!-- Upload Zone -->
            <div class="upload-card">
                <h3><i class="fas fa-cloud-upload-alt"></i> Subir Documentos</h3>
                
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <div class="drop-zone-text">
                        Arrastra archivos aquí o haz clic para seleccionar
                    </div>
                    <div class="drop-zone-hint">
                        PDF, TXT, DOC, DOCX (Máx. 10MB por archivo)
                    </div>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.txt,.doc,.docx">
                </div>

                <div class="document-types">
                    <div class="type-badge"><i class="fas fa-file-pdf"></i> PDF</div>
                    <div class="type-badge"><i class="fas fa-file-alt"></i> TXT</div>
                    <div class="type-badge"><i class="fas fa-file-word"></i> DOC/DOCX</div>
                </div>

                <button class="btn-upload" id="uploadButton" disabled>
                    <i class="fas fa-upload"></i> Procesar y Entrenar
                </button>
            </div>

            <!-- Training Options -->
            <div class="upload-card">
                <h3><i class="fas fa-cog"></i> Opciones de Entrenamiento</h3>
                
                <div class="training-options">
                    <h4>Tipo de Contenido</h4>
                    <div class="options-grid">
                        <div class="option-card selected" data-type="supplements">
                            <h5><i class="fas fa-pills"></i> Suplementos</h5>
                            <p>Información sobre suplementos deportivos</p>
                        </div>
                        <div class="option-card" data-type="nutrition">
                            <h5><i class="fas fa-apple-alt"></i> Nutrición</h5>
                            <p>Guías de alimentación para runners</p>
                        </div>
                        <div class="option-card" data-type="training">
                            <h5><i class="fas fa-running"></i> Entrenamiento</h5>
                            <p>Planes y consejos de entrenamiento</p>
                        </div>
                        <div class="option-card" data-type="science">
                            <h5><i class="fas fa-flask"></i> Ciencia</h5>
                            <p>Estudios y evidencia científica</p>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="autoProcess" checked>
                        <span>Procesar automáticamente después de subir</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- File List -->
        <div class="upload-card">
            <h3><i class="fas fa-list"></i> Archivos Seleccionados</h3>
            <div id="fileList" class="file-list">
                <div style="text-align: center; color: #94a3b8; padding: 2rem;">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                    No hay archivos seleccionados
                </div>
            </div>
        </div>

        <!-- Recent Uploads -->
        <div class="upload-card">
            <h3><i class="fas fa-history"></i> Documentos Recientes</h3>
            <div id="recentUploads">
                <p style="color: #64748b;">Cargando historial...</p>
            </div>
        </div>

        <!-- Back to Dashboard -->
        <div style="text-align: center; margin-top: 2rem;">
            <a href="training-dashboard.html" class="btn-upload btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Dashboard
            </a>
            <a href="index.html" class="btn-upload btn-secondary" style="margin-left: 1rem;">
                <i class="fas fa-home"></i> Ir a Inicio
            </a>
        </div>
    </div>

    <script>
        class DocumentUploadManager {
            constructor() {
                this.apiBase = 'http://localhost:3000/api';
                this.selectedFiles = [];
                this.selectedContentType = 'supplements';
                this.init();
            }

            init() {
                this.setupDropZone();
                this.setupFileInput();
                this.setupUploadButton();
                this.setupContentTypeSelector();
                this.loadStats();
                this.loadRecentUploads();
            }

            setupDropZone() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');

                dropZone.addEventListener('click', () => {
                    fileInput.click();
                });

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    this.handleFiles(files);
                });
            }

            setupFileInput() {
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    this.handleFiles(files);
                });
            }

            setupUploadButton() {
                const uploadButton = document.getElementById('uploadButton');
                uploadButton.addEventListener('click', () => {
                    this.uploadAndProcess();
                });
            }

            setupContentTypeSelector() {
                const options = document.querySelectorAll('.option-card');
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        options.forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.selectedContentType = option.dataset.type;
                    });
                });
            }

            handleFiles(files) {
                // Filter valid files
                const validFiles = files.filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    const validExtensions = ['pdf', 'txt', 'doc', 'docx'];
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    
                    if (!validExtensions.includes(ext)) {
                        this.showAlert('error', `Formato no válido: ${file.name}`);
                        return false;
                    }
                    
                    if (file.size > maxSize) {
                        this.showAlert('error', `Archivo muy grande: ${file.name} (Máx. 10MB)`);
                        return false;
                    }
                    
                    return true;
                });

                this.selectedFiles = [...this.selectedFiles, ...validFiles];
                this.renderFileList();
                document.getElementById('uploadButton').disabled = this.selectedFiles.length === 0;
            }

            renderFileList() {
                const fileList = document.getElementById('fileList');
                
                if (this.selectedFiles.length === 0) {
                    fileList.innerHTML = `
                        <div style="text-align: center; color: #94a3b8; padding: 2rem;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                            No hay archivos seleccionados
                        </div>
                    `;
                    return;
                }

                fileList.innerHTML = this.selectedFiles.map((file, index) => `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-file-${this.getFileIcon(file.name)}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${this.formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn-icon" onclick="uploadManager.removeFile(${index})" title="Eliminar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            getFileIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const icons = {
                    'pdf': 'pdf',
                    'txt': 'alt',
                    'doc': 'word',
                    'docx': 'word'
                };
                return icons[ext] || 'alt';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            }

            removeFile(index) {
                this.selectedFiles.splice(index, 1);
                this.renderFileList();
                document.getElementById('uploadButton').disabled = this.selectedFiles.length === 0;
            }

            async uploadAndProcess() {
                if (this.selectedFiles.length === 0) return;

                const modal = document.getElementById('processingModal');
                modal.classList.add('active');

                const formData = new FormData();
                this.selectedFiles.forEach((file, index) => {
                    formData.append('documents', file);
                });
                formData.append('contentType', this.selectedContentType);

                try {
                    const response = await fetch(`${this.apiBase}/documents/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showAlert('success', `¡${result.processed} documento(s) procesado(s) correctamente!`);
                        this.selectedFiles = [];
                        this.renderFileList();
                        document.getElementById('uploadButton').disabled = true;
                        document.getElementById('fileInput').value = '';
                        this.loadStats();
                        this.loadRecentUploads();
                    } else {
                        this.showAlert('error', result.message || 'Error al procesar documentos');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    this.showAlert('error', 'Error al subir documentos. Asegúrate de que el servidor esté funcionando.');
                } finally {
                    modal.classList.remove('active');
                }
            }

            async loadStats() {
                try {
                    const response = await fetch(`${this.apiBase}/documents/stats`);
                    const stats = await response.json();
                    
                    document.getElementById('totalDocuments').textContent = stats.totalDocuments || 0;
                    document.getElementById('totalPages').textContent = stats.totalPages || 0;
                    document.getElementById('trainingDataPoints').textContent = stats.trainingDataPoints || 0;
                } catch (error) {
                    console.error('Stats error:', error);
                }
            }

            async loadRecentUploads() {
                try {
                    const response = await fetch(`${this.apiBase}/documents/recent`);
                    const recent = await response.json();
                    
                    const container = document.getElementById('recentUploads');
                    
                    if (!recent || recent.length === 0) {
                        container.innerHTML = '<p style="color: #64748b;">No hay documentos recientes</p>';
                        return;
                    }

                    container.innerHTML = recent.map(doc => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-icon">
                                    <i class="fas fa-file-${this.getFileIcon(doc.filename)}"></i>
                                </div>
                                <div class="file-details">
                                    <div class="file-name">${doc.filename}</div>
                                    <div class="file-size">
                                        ${doc.contentType} • ${new Date(doc.uploadDate).toLocaleDateString()} • ${doc.dataPoints} puntos de datos
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Recent uploads error:', error);
                }
            }

            showAlert(type, message) {
                const alertTypes = {
                    'success': { icon: 'check-circle', class: 'alert-success' },
                    'error': { icon: 'exclamation-circle', class: 'alert-error' },
                    'info': { icon: 'info-circle', class: 'alert-info' }
                };

                const config = alertTypes[type];
                const alert = document.createElement('div');
                alert.className = `alert ${config.class}`;
                alert.innerHTML = `
                    <div class="alert-icon"><i class="fas fa-${config.icon}"></i></div>
                    <div>${message}</div>
                `;

                document.querySelector('.upload-container').insertBefore(
                    alert,
                    document.querySelector('.upload-header').nextSibling
                );

                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
        }

        // Initialize on page load
        let uploadManager;
        document.addEventListener('DOMContentLoaded', () => {
            uploadManager = new DocumentUploadManager();
        });
    </script>
</body>
</html>

